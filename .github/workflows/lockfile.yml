name: Check Lockfile
on:
  pull_request:

jobs:
  lockfile_version:
    name: Lockfile version check
    runs-on: ubuntu-latest
    steps:
      - name: Check out a copy of the repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Check package-lock.json version has not been changed
        uses: mansona/npm-lockfile-version@85d9138b7776b4f8f768259f8a3e4f2611457d8f # v1
        with:
          version: 3
  lockfile_changes:
    name: Lockfile changes check
    runs-on: ubuntu-latest
    steps:
      - name: Check out a copy of the repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: app-token
        with:
          app-id: ${{ vars.LOCKFILE_BOT_APP_ID }}
          private-key: ${{ secrets.LOCKFILE_BOT_PRIVATE_KEY }}
      - name: NPM Lockfile Changes
        # The original doesn't support v3 lockfiles so we use a fork that adds support for them
        # The fork doesn't update comments by an app token, so we use our own fork
        uses: digidem/npm-lockfile-changes@614dfc33742374cb40bec2878e5b690580d11ede
        with:
          token: ${{ steps.app-token.outputs.token }}
          updateComment: true
